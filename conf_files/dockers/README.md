# Docker configurations

## List of docker images

* [Mosquitto for MQTT support](https://hub.docker.com/_/eclipse-mosquitto)
* [Telegraf for influxdb data ingestion](https://registry.hub.docker.com/_/telegraf/)
* [InfluxDB for the database](https://registry.hub.docker.com/_/influxdb/)
* [Grafana for monitoring dashboard](https://registry.hub.docker.com/r/grafana/grafana)

## How to install
  ```bash
  # Quick note: on DSM you can directly launch those with sudo
  docker pull eclipse-mosquitto
  docker pull telegraf
  docker pull influxdb
  docker pull grafana/grafana
  ```

## Mosquitto

### Customize and setup
Three directories have been created in the image to be used for configuration, persistent storage and logs.

  ```bash
  /mosquitto/config
  /mosquitto/data
  /mosquitto/log
  ```
When running the image, the default configuration values are used. To use a custom configuration file, mount a local configuration file to /mosquitto/config/mosquitto.conf
Sample mosquitto.conf can be found [here](https://github.com/eclipse/mosquitto)

  ```bash
  docker run -it -p 1883:1883 -p 9001:9001 -v mosquitto.conf:/mosquitto/config/mosquitto.conf eclipse-mosquitto
  ```
Configuration can be changed to:

* persist data to /mosquitto/data
* log to /mosquitto/log/mosquitto.log
i.e. add the following to mosquitto.conf:
  ```bash
  persistence true
  persistence_location /mosquitto/data/
  log_dest file /mosquitto/log/mosquitto.log
  ```
Note: If a volume is used, the data will persist between containers.

Run a container using the new image:

  ```bash
  docker run -it -p 1883:1883 -p 9001:9001 -v mosquitto.conf:/mosquitto/config/mosquitto.conf -v /mosquitto/data -v /mosquitto/log eclipse-mosquitto
  ```
Note that if you start a container with a volume that does not yet exist, Docker creates the volume for you. 

### test

In one shell, launch the following commands
  ```bash
  sudo apt-get install mosquitto-clients
  mosquitto_sub -h 192.168.0.48 -p 1883 -t remoteobservatory/# -d
  ```
  And to test, simply publish in another shell, and check the first one
  ```bash
  mosquitto_pub -h 192.168.0.48 -p 1883 -t remoteobservatory/hello -m "world" -d
  ```

## InfluxDB (version 2.X)

The InfluxDB image contains some extra functionality to automatically bootstrap the system. This functionality is enabled by setting the DOCKER_INFLUXDB_INIT_MODE environment variable to the value "setup", when running the container. Additional environment variables are used to configure the setup logic:

* DOCKER_INFLUXDB_INIT_USERNAME: The username to set for the system's initial super-user (Required).
* DOCKER_INFLUXDB_INIT_PASSWORD: The password to set for the system's inital super-user (Required).
* DOCKER_INFLUXDB_INIT_ORG: The name to set for the system's initial organization (Required).
* DOCKER_INFLUXDB_INIT_BUCKET: The name to set for the system's initial bucket (Required).
* DOCKER_INFLUXDB_INIT_RETENTION: The duration the system's initial bucket should retain data. If not set, the initial bucket will retain data forever.
* DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: The authentication token to associate with the system's initial super-user. If not set, a token will be auto-generated by the system.

Automated setup will generate metadata files and CLI configurations. It's recommended to mount volumes at both paths to avoid losing data.

For example, a minimal invocation of automated setup is:

  ```bash
  docker run -d -p 8086:8086 \
      -v $PWD/data:/var/lib/influxdb2 \
      -v $PWD/config:/etc/influxdb2 \
      -e DOCKER_INFLUXDB_INIT_MODE=setup \
      -e DOCKER_INFLUXDB_INIT_USERNAME=remoteobservatory \
      -e DOCKER_INFLUXDB_INIT_PASSWORD=remoteobservatory \
      -e DOCKER_INFLUXDB_INIT_ORG=remoteobservatory \
      -e DOCKER_INFLUXDB_INIT_BUCKET=remoteobservatory \
      -e DOCKER_INFLUXDB_INIT_RETENTION=52w \
      -e DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=remoteobservatory \
      influxdb
  ```

NOTE: Automated setup will not run if an existing boltdb file is found at the configured path. This behavior allows for the InfluxDB container to reboot post-setup without encountering "DB is already set up" errors.



InfluxDB can be configured using a mix of a config file, environment variables, and CLI options. To mount a configuration file and use it with the server, you can use this command to generate the default configuration file:

  ```bash
  docker run --rm influxdb influxd print-config > config.yml
  ```
Modify the default configuration, which will now be available under $PWD. Then start the InfluxDB container:

  ```bash
  docker run -p 8086:8086 \
      -v $PWD/config.yml:/etc/influxdb2/config.yml \
      -v $PWD/config:/etc/influxdb2 \
      influxdb
  ```

## Telegraf

The default configuration requires a running InfluxDB instance as an output plugin. Ensure that InfluxDB is running on port 8086 before starting the Telegraf container.
Minimal example to start an InfluxDB container:

  ```bash
  docker run -d --name influxdb -p 8086:8086 influxdb
  ```
Starting Telegraf using the default config, which connects to InfluxDB at http://localhost:8086/:

  ```bash
  docker run --net=container:influxdb telegraf
  ```
Using a custom config file
First, generate a sample configuration and save it as telegraf.conf on the host:

  ```bash
  docker run --rm telegraf telegraf config > telegraf.conf
  ```
When customizing the config, pay attention to the following sections:
* inputs.mqtt_consumer
* outputs.influxdb_v2

Check [this](https://www.influxdata.com/blog/mqtt-topic-payload-parsing-telegraf/) for more infos

Once you've customized telegraf.conf, you can run the Telegraf container with it mounted in the expected location:

  ```bash
  docker run -v $PWD/telegraf.conf:/etc/telegraf/telegraf.conf:ro telegraf
  ```
Modify $PWD to the directory where you want to store the configuration file.



## Grafana

  ```bash
  docker run -d --name=grafana -p 3000:3000 grafana/grafana
  ```

Try it out, default admin user credentials are admin/admin.
Further documentation can be found [here](http://docs.grafana.org/installation/docker/)

Now you will have to configure your influxdb data source, it is important to select FLUX as the query language, not the other one (influxQL)
url: http://influxdb-remoteobservatory:8086
access: server
No nead to setup any authentication process
No custom http header
InfluxDB details:
Organization: remoteobservatory
Token: remoteobservatory
Default bucket: remoteobservatory


## Docker compose stuff
You might find this page helpful: https://community.influxdata.com/t/telegraf-mqtt-connection-network-error/22952
